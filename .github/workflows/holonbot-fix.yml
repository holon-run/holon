name: Holonbot Fix Workflow

on:
  issue_comment:
    types: [created]

# Global permissions for the workflow
permissions:
  contents: read
  pull-requests: read
  issues: read

# Concurrency control to prevent multiple runs per PR per user
# Include actor in group key so different users' comments don't cancel each other's runs
concurrency:
  group: holonbot-fix-pr-${{ github.event.issue.number }}-${{ github.actor }}
  cancel-in-progress: true

jobs:
  parse-and-gate:
    name: Parse Comment and Check Gates
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.decision.outputs.should_run }}
      pr_number: ${{ steps.pr-check.outputs.pr_number }}
      reason: ${{ steps.decision.outputs.reason }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if comment is on a PR
        id: pr-check
        run: |
          # In issue_comment events, if the issue is a PR, the payload will contain
          # the issue.pull_request field. We can check this directly from the event context.
          # This is more reliable than calling gh pr view.

          # Check if pull_request field exists by checking its URL property
          PR_URL="${{ github.event.issue.pull_request.html_url }}"

          if [ -n "$PR_URL" ]; then
            echo "is_pull_request=true" >> $GITHUB_OUTPUT
            echo "pr_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "Found PR #${{ github.event.issue.number }}"
          else
            echo "is_pull_request=false" >> $GITHUB_OUTPUT
            echo "Not a pull request - skipping"
          fi

      - name: Parse comment and check gates
        id: decision
        if: steps.pr-check.outputs.is_pull_request == 'true'
        run: |
          PR_NUMBER="${{ steps.pr-check.outputs.pr_number }}"
          COMMENT_BODY="${{ github.event.comment.body }}"
          ACTOR="${{ github.actor }}"

          echo "Analyzing comment from user: $ACTOR"
          echo "Comment body:"
          echo "$COMMENT_BODY" | head -c 500
          echo ""

          # Gate 1: Check if actor is not holonbot[bot]
          if [ "$ACTOR" = "holonbot[bot]" ]; then
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "reason=Actor is holonbot[bot] - skipping" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Gate 2: Check if first line is exactly "@holonbot fix"
          FIRST_LINE=$(echo "$COMMENT_BODY" | head -n1 | xargs)
          if [ "$FIRST_LINE" != "@holonbot fix" ]; then
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "reason=First line is not '@holonbot fix' - found: '$FIRST_LINE'" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Gate 3: Check if PR is not a fork
          # Use isCrossRepository field which is true when head and base repos are different
          IS_FORK=$(gh pr view "$PR_NUMBER" --json isCrossRepository --jq '.isCrossRepository')

          if [ "$IS_FORK" = "true" ]; then
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "reason=PR is from a fork repository - not supported in MVP" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Gate 4: Check if commenter has write or maintain permissions
          PERMS=$(gh api "user/${ACTOR}" --jq '.permissions' 2>/dev/null || echo '{}')
          CAN_WRITE=$(echo "$PERMS" | jq -r '.push // false' 2>/dev/null || echo 'false')
          CAN_MAINTAIN=$(echo "$PERMS" | jq -r '.maintain // false' 2>/dev/null || echo 'false')
          IS_COLLABORATOR=$(gh api "repos/${{ github.repository }}/collaborators/${ACTOR}" --jq '.' 2>/dev/null && echo 'true' || echo 'false')

          if [ "$CAN_WRITE" = "true" ] || [ "$CAN_MAINTAIN" = "true" ] || [ "$IS_COLLABORATOR" = "true" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "reason=All gates passed - running Holon fix" >> $GITHUB_OUTPUT
            echo "‚úÖ All gates passed:"
            echo "  - Actor: $ACTOR (not holonbot[bot])"
            echo "  - Command: @holonbot fix"
            echo "  - PR: #$PR_NUMBER (not a fork)"
            echo "  - Permissions: Write/Maintain access confirmed"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "reason=User $ACTOR lacks write/maintain permissions" >> $GITHUB_OUTPUT
            exit 0
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  run-holon-fix:
    name: Run Holon Fix
    runs-on: ubuntu-latest
    needs: parse-and-gate
    if: needs.parse-and-gate.outputs.should_run == 'true'
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Call Holon Solve
        uses: ./.github/workflows/holon-solve.yml
        with:
          issue_number: ${{ needs.parse-and-gate.outputs.pr_number }}
          comment_body: ${{ github.event.comment.body }}
          # mode will be auto-detected as pr-fix
          log_level: 'debug'
          workspace: '.'
          out_dir: './holon-output'
        secrets:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_base_url: ${{ secrets.ANTHROPIC_BASE_URL || 'https://api.anthropic.com' }}

  skip-execution:
    name: Skip Execution (Gates Failed)
    runs-on: ubuntu-latest
    needs: parse-and-gate
    if: needs.parse-and-gate.outputs.should_run != 'true'
    steps:
      - name: Log skip reason
        run: |
          echo "‚è≠Ô∏è Skipping Holon execution"
          echo "üìã Reason: ${{ needs.parse-and-gate.outputs.reason }}"
          echo "üë§ Actor: ${{ github.actor }}"
          echo "üîç Issue: #${{ github.event.issue.number }}"
