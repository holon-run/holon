name: Publish Claude Agent Bundle

on:
  push:
    branches: [ "main" ]
    paths:
      - 'agents/claude/package.json'

permissions:
  contents: write
  issues: write

jobs:
  publish-agent-bundle:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Fetch all tags
      run: git fetch --tags --force

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Get package version
      id: version
      run: |
        VERSION=$(node -e "const p=require('./agents/claude/package.json'); console.log(p.version)")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Package version: $VERSION"

    - name: Check if tag exists
      id: check_tag
      run: |
        TAG="agent-claude-v${{ steps.version.outputs.version }}"
        # After fetching all tags, we only need to check locally
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Tag $TAG already exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Tag $TAG does not exist"
        fi

    - name: Build agent bundle
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        cd agents/claude
        npm ci
        npm run bundle

    - name: Prepare release assets
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        cd agents/claude
        chmod +x scripts/prepare-release-assets.sh
        ./scripts/prepare-release-assets.sh ${{ steps.version.outputs.version }} > /tmp/release-assets.env

        # Validate that expected environment variables were produced
        set -a
        . /tmp/release-assets.env
        set +a

        if [ -z "$bundle_file" ] || [ -z "$checksum_file" ]; then
          echo "Error: Expected bundle_file and checksum_file to be set in /tmp/release-assets.env" >&2
          echo "Contents of /tmp/release-assets.env:" >&2
          cat /tmp/release-assets.env >&2 || true
          exit 1
        fi

        cat /tmp/release-assets.env >> "$GITHUB_ENV"

    - name: Validate release assets
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        if [ ! -f "${{ env.bundle_file }}" ]; then
          echo "Error: Bundle file not found at ${{ env.bundle_file }}" >&2
          exit 1
        fi
        if [ ! -f "${{ env.checksum_file }}" ]; then
          echo "Error: Checksum file not found at ${{ env.checksum_file }}" >&2
          exit 1
        fi

    - name: Create and push tag
      id: push_tag
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        TAG="agent-claude-v${{ steps.version.outputs.version }}"
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a "$TAG" -m "Release Claude Agent v${{ steps.version.outputs.version }}"

        # Try to push tag, handle race condition
        if git push origin "$TAG" 2>/dev/null; then
          echo "pushed=true" >> $GITHUB_OUTPUT
          echo "Tag $TAG pushed successfully"
        else
          # Check if tag exists remotely now
          if git ls-remote --tags origin "$TAG" | grep -q "$TAG"; then
            echo "pushed=false" >> $GITHUB_OUTPUT
            echo "Tag $TAG already exists remotely, skipping push"
          else
            echo "pushed=false" >> $GITHUB_OUTPUT
            echo "Failed to push tag $TAG and it doesn't exist remotely" >&2
            exit 1
          fi
        fi

    - name: Create GitHub Release
      if: steps.check_tag.outputs.exists == 'false' && steps.push_tag.outputs.pushed == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: agent-claude-v${{ steps.version.outputs.version }}
        name: Claude Agent v${{ steps.version.outputs.version }}
        body: |
          Claude Agent Bundle v${{ steps.version.outputs.version }}

          ## Assets
          - `holon-agent-claude-${{ steps.version.outputs.version }}.tar.gz` - Agent bundle
          - `holon-agent-claude-${{ steps.version.outputs.version }}.tar.gz.sha256` - SHA256 checksum

          ## Usage
          ```bash
          # Download and verify
          curl -L -o holon-agent-claude-${{ steps.version.outputs.version }}.tar.gz "https://github.com/${{ github.repository }}/releases/download/agent-claude-v${{ steps.version.outputs.version }}/holon-agent-claude-${{ steps.version.outputs.version }}.tar.gz"
          curl -L -o holon-agent-claude-${{ steps.version.outputs.version }}.tar.gz.sha256 "https://github.com/${{ github.repository }}/releases/download/agent-claude-v${{ steps.version.outputs.version }}/holon-agent-claude-${{ steps.version.outputs.version }}.tar.gz.sha256"

          # Verify checksum
          sha256sum -c holon-agent-claude-${{ steps.version.outputs.version }}.tar.gz.sha256

          # Use with Holon CLI
          holon run --agent holon-agent-claude-${{ steps.version.outputs.version }}.tar.gz --spec your-spec.yaml
          ```
        files: |
          ${{ env.bundle_file }}
          ${{ env.checksum_file }}
        draft: false
        prerelease: false

    - name: Create/update builtin agent update issue
      if: steps.check_tag.outputs.exists == 'false' && steps.push_tag.outputs.pushed == 'true'
      run: |
        TAG="agent-claude-v${{ steps.version.outputs.version }}"
        BUNDLE_URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/holon-agent-claude-${{ steps.version.outputs.version }}.tar.gz"

        # Extract SHA256 checksum (format: "checksum filename")
        SHA256=$(awk '{print $1}' "${{ env.checksum_file }}")

        # Issue title
        TITLE="Update builtin agent to ${TAG}"

        # Issue body
        BODY=$(cat <<EOF
        A new Claude agent bundle has been released. Update the builtin agent configuration to use the latest version.

        ## Release Details

        - **Tag**: \`${TAG}\`
        - **Version**: \`${{ steps.version.outputs.version }}\`
        - **Bundle URL**: \`${BUNDLE_URL}\`
        - **SHA256 Checksum**: \`${SHA256}\`

        ## Update Instructions

        Please update the following files:

        ### 1. Update \`pkg/agent/builtin.go\`

        Update the \`DefaultBuiltinAgent()\` function with the new values:

        \`\`\`go
        func DefaultBuiltinAgent() *BuiltinAgent {
            return &BuiltinAgent{
                Name:     \"claude-agent\",
                Version:  \"${TAG}\",
                URL:      \"${BUNDLE_URL}\",
                Checksum: \"${SHA256}\",
            }
        }
        \`\`\`

        ### 2. Update Tests (if applicable)

        Check for any hardcoded version references in test files (e.g., \`tests/integration/testdata/builtin-agent.txtar\`) and update them to reference the new tag.

        ### 3. Verification

        After updating, verify the changes:
        - Run \`make test\` to ensure all tests pass
        - Run \`holon agent info default\` to verify the new configuration
        - Test the agent bundle download and installation

        ---

        *This issue was automatically created by the [publish-agent-bundle](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) workflow.*
        EOF
        )

        # Check if an open issue with this title already exists
        echo "Checking for existing open issue with title: ${TITLE}"
        if ! EXISTING_ISSUES=$(gh issue list \
          --repo "${{ github.repository }}" \
          --search "in:title ${TITLE}" \
          --state open \
          --json number \
          --jq '.[].number'); then
          echo "Error: failed to list existing issues with gh" >&2
          exit 1
        fi

        if [ -n "$EXISTING_ISSUES" ]; then
          # Update the first existing issue
          ISSUE_NUMBER=$(echo "$EXISTING_ISSUES" | head -n1)
          echo "Found existing issue #${ISSUE_NUMBER}, updating..."
          gh issue update "${ISSUE_NUMBER}" \
            --repo "${{ github.repository }}" \
            --body "$BODY"
          echo "Issue #${ISSUE_NUMBER} updated successfully"
        else
          # Create a new issue
          echo "No existing issue found, creating new issue..."
          gh issue create \
            --repo "${{ github.repository }}" \
            --title "${TITLE}" \
            --body "$BODY" \
            --label "dependencies"
          echo "New issue created successfully"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}