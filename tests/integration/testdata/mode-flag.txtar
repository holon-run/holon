[!docker] skip 'docker not available'

mkdir work
mkdir out
mkdir bundle-src
mkdir bundle-src/bin

# Force TMPDIR to be inside the workspace to exercise snapshot recursion protection.
mkdir work/tmp
env TMPDIR=work/tmp

exec chmod +x bundle-src/bin/agent
exec tar -czf agent-bundle.tar.gz -C bundle-src .
exec holon run --goal 'test mode flag' --name mode-test --workspace work --out out --image debian:bookworm-slim --agent-bundle agent-bundle.tar.gz --log-level minimal --mode plan

exists out/manifest.json
exists out/diff.patch
exists out/summary.md
stderr 'mode.*plan'

-- bundle-src/manifest.json --
{
  "bundleVersion": "1",
  "name": "agent-stub",
  "version": "0.0.0",
  "entry": "bin/agent",
  "platform": "linux",
  "arch": "amd64",
  "libc": "glibc",
  "runtime": {
    "type": "node",
    "version": "20"
  }
}

-- bundle-src/bin/agent --
#!/bin/sh
set -eu
mkdir -p /holon/output

# Read the mode from environment and include it in manifest
MODE=${HOLON_MODE:-execute}
cat > /holon/output/manifest.json <<EOF
{
  "status": "completed",
  "outcome": "success",
  "mode": "${MODE}",
  "artifacts": [
    { "name": "manifest.json", "path": "manifest.json" },
    { "name": "diff.patch", "path": "diff.patch" },
    { "name": "summary.md", "path": "summary.md" }
  ]
}
EOF

echo 'diff' > /holon/output/diff.patch
echo '# summary' > /holon/output/summary.md

# Print mode to stderr for verification
echo "Running in mode: ${MODE}" >&2